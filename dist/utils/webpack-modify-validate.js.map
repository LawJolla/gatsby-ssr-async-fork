{"version":3,"sources":["../../src/utils/webpack-modify-validate.js"],"names":["validationWhitelist","object","stylus","any","sassLoader","sassResources","string","array","items","ValidateWebpackConfig","config","stage","isObject","isFunction","resolve","validationState","returnValidation","schemaExtension","error","console","log","details","forEach","err","index","path","type","message","process","exit"],"mappings":";;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,MAAMA,sBAAsB,sBAAIC,MAAJ,CAAW;AACrCC,UAAQ,sBAAIC,GAAJ,EAD6B;AAErCC,cAAY,sBAAID,GAAJ,EAFyB;AAGrCE,iBAAe,CAAC,sBAAIC,MAAJ,EAAD,EAAe,sBAAIC,KAAJ,GAAYC,KAAZ,CAAkB,sBAAIF,MAAJ,EAAlB,CAAf;AAHsB,CAAX,CAA5B;;kBAMgB,eAAeG,qBAAf,CAAqCC,MAArC,EAA6CC,KAA7C,EAAoD;AAClE;AACA,QAAM,6BAAe,qBAAf,EAAqC,EAAED,MAAF,EAAUC,KAAV,EAArC,CAAN;;AAEA;;AAEA,2BACE,iBAAEC,QAAF,CAAWF,MAAX,KAAsB,iBAAEG,UAAF,CAAaH,OAAOI,OAApB,CADxB,EAEG;;gBAEWJ,MAAO;aACVC,KAAM;KALjB;;AASA,QAAMI,kBAAkB,gCAASL,OAAOI,OAAP,EAAT,EAA2B;AACjDE,sBAAkB,IAD+B;AAEjDC,qBAAiBjB;AAFgC,GAA3B,CAAxB;;AAKA,MAAI,CAACe,gBAAgBG,KAArB,EAA4B;AAC1B,WAAOR,MAAP;AACD;;AAEDS,UAAQC,GAAR,CAAa,6CAAb;AACAL,kBAAgBG,KAAhB,CAAsBG,OAAtB,CAA8BC,OAA9B,CAAsC,CAACC,GAAD,EAAMC,KAAN,KAAgB;AACpDL,YAAQC,GAAR,CAAa,IAAGI,QAAQ,CAAE,GAA1B;AACAL,YAAQC,GAAR,CAAYG,IAAIE,IAAhB;AACAN,YAAQC,GAAR,CAAYG,IAAIG,IAAhB,EAAuB,GAAvB,EAA2BH,IAAII,OAA/B;AACAR,YAAQC,GAAR,CAAa,IAAb;AACD,GALD;;AAOAD,UAAQC,GAAR,CAAY,qBAAY;;;;GAAxB;;AAMA,SAAOQ,QAAQC,IAAR,CAAa,CAAb,CAAP;AACD,C","file":"webpack-modify-validate.js","sourcesContent":["import _ from \"lodash\"\nimport invariant from \"invariant\"\nimport validate, { Joi } from \"webpack-validator\"\nimport stripIndent from \"common-tags/lib/stripIndent\"\nimport apiRunnerNode from \"./api-runner-node\"\n\n// We whitelist special config keys that are not part of a standard Webpack v1\n// config but are in common usage. We should be able to completely remove this\n// once we're on Webpack v3.\n//\n// For info on whitelisting with webpack-validator see:\n// https://github.com/js-dxtools/webpack-validator#customizing\nconst validationWhitelist = Joi.object({\n  stylus: Joi.any(),\n  sassLoader: Joi.any(),\n  sassResources: [Joi.string(), Joi.array().items(Joi.string())],\n})\n\nexport default (async function ValidateWebpackConfig(config, stage) {\n  // We don't care about the return as plugins just mutate the config directly.\n  await apiRunnerNode(`modifyWebpackConfig`, { config, stage })\n\n  // console.log(JSON.stringify(config, null, 4))\n\n  invariant(\n    _.isObject(config) && _.isFunction(config.resolve),\n    `\n    You must return an webpack-configurator instance when modifying the Webpack config.\n    Returned: ${config}\n    stage: ${stage}\n    `\n  )\n\n  const validationState = validate(config.resolve(), {\n    returnValidation: true,\n    schemaExtension: validationWhitelist,\n  })\n\n  if (!validationState.error) {\n    return config\n  }\n\n  console.log(`There were errors with your webpack config:`)\n  validationState.error.details.forEach((err, index) => {\n    console.log(`[${index + 1}]`)\n    console.log(err.path)\n    console.log(err.type, `,`, err.message)\n    console.log(`\\n`)\n  })\n\n  console.log(stripIndent`\n    Your Webpack config does not appear to be valid. This could be because of\n    something you added or a plugin. If you don't recognize the invalid keys listed\n    above try removing plugins and rebuilding to identify the culprit.\n  `)\n\n  return process.exit(1)\n})\n"]}